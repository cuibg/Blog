## 《图解TCP/IP（第5版）》读书笔记

了解计算机网络相关知识对一名程序员来说是必不可少的。大学时学过这门课，只可惜基本都已还给老师。为了系统掌握计算机网络方面的基础内容，特地选择了《图解TCP/IP（第5版）》这本书。

这是一本入门级教材，全书以图文并茂的方式，从计算机网络的诞生开始讲起，简单的介绍了TCP/IP协议簇的知识，适合0基础或者基础薄弱的同学使用。

以下都是我认为本书中值得我注意的知识点，摘抄下来以备温习：

#### 第一章 网络基础知识

##### 计算机和计算机网络发展的7个阶段

计算机网络的发展离不开计算机的发展，从20世纪50年代计算机开始普及到现在，计算机的使用模式发生了诸多变化。计算机与网络的发展大致可分为7个阶段。

* 批处理

最初，计算机的价格昂贵体积巨大，无法再一般得办公场所中使用，通常放置在专门的计算机管理中心；再加上计算机操作起来相当复杂，必须由专门的管理人员处理。计算机的这种特点，使得用户只能事先将程序和数据装入卡带或磁带送到这样的中心去运行，过些时日再来取结果。

批处理时代的计算机主要用于大规模计算或处理。

* 分时系统

随后，20世纪60年代出现了分时系统（TTS）。它是指多个终端（由键盘、显示器等输入输出设备组成）与同一台计算机相连，允许多个用户同时使用一台计算机系统。这依然是因为计算机的造价过于昂贵，一人一机对一般人来说不可能实现。但分时系统给用户的感觉就像是一个人完全在使用一台计算机一样。

正是从这一时期开始，网络（通信）与计算机之间的关系逐渐浮出水面。小型机也随即产生，办公场所与工厂逐渐引入计算机。

* 计算机之间的通信

20世纪70年代，计算机性能有了飞速发展，体积也趋于小型化，同时价格急剧下降，使得计算机从科研机关逐渐走向企业。为了提高效率，人们开始研究计算机与计算机之间的通信技术。

计算机通信显著提高了计算机的可用性，人们不再局限使用一台计算机进行处理，而是逐渐使用多台计算机分布式处理，最终一并得到返回结果。

从此，计算机的发展进入了一个崭新的历史阶段。


* 计算机网络的产生

20世纪70年代初期，人们开始实验基于分组交换技术的计算机网络，并着手研究不同厂商的计算机之间相互通信技术。

80年代，一种能够互联多种计算机的网络随即产生，它能够练级从大型超级计算机到小型机的各式各样的计算机。具有GUI图形界面的操作系统的出现更拉近了人们与网络之间的距离，使得用户体会到了网络的便捷之处。

* 互联网的普及

进入20世纪90年代，有些公司和大学已经具备了一人一机的环境。人们期望一个连接不同厂商的不同机型的成本更低的网络环境，于是出现了连接异构型计算机的通信网络技术----互联网技术。

个人电脑在诞生之初可以说是一种单机模式的工具，而现在它则被更广泛的应用于互联网的访问。

* 以互联网技术为中心的时代

互联网的普及和发展对通信领域产生了巨大影响，许多发展道路各不相同的网络技术也都在向互联网靠拢。例如，曾经一直作为通信基础设施、支撑通信网络的电话为，其地位也随着时间的推移为IP(Internet Protocol)网所取代。并且，能够联网的设备也不仅限于单纯的计算机，还扩展到了手机、家用电器、游戏机等许多其它产品。

* 从"单纯建立连接"到"安全建立连接"

互联网普及的初期，人们更关注单纯的连接性，以不受任何限制地建立互联网连接为最终目的。而现在，人们更追求"安全建立连接"的目标。


##### 计算机网络标准化过程

* 协议的标准化

`ISO`制定了一个国际标准`OSI`，对通信系统进行了标准化。由于种种原因，`OSI`并没有得到普及，但是在`OSI`协议设计之初作为其指导方针的OSI参考模型却常被用于网络协议的制定当中。

`TCP/IP`是由`IETF`建议的、致力于推进其标准化作业的一种协议，后来逐渐成为业界标准，被广泛应用。

##### 传输方式的分类

网络与通信中可以根据其数据发送方法进行多种分类：

* 面向有连接型与面向无连接型

面向有连接型发送数据前需要在收发主机之间建立一条通信线路；

面向无连接则不需要建立和断开连接。

* 电路交换与分组交换

电路交换技术相对久远，主要用于过去的电话网，交换机负责数据的中转处理。计算机首先被连接到交换机上，而交换机与交换机之间则由众多通信线路再继续连接。因此计算机之间发送数据时，需要通过交换机与目标主机建立通信电路，电路建好后，用户可以一直使用，直到连接被断开为止。独占线路意味着这段时间内其它用户都用不了，如果并发用户数超过交换机之间的通信线路数，通信根本无法实现。

在分组交换中，计算机与路由器之间以及路由器和路由器之间通常只有一条通信线路，因此，这条线路其实是共享线路。

电路交换中，由于独占线路，传输速度不会发生改变；分组交换中，通信线路的速度根据网络拥堵情况可能会发生变化，甚至出现分组数据丢失、无法发送到对端的情况。

* 根据接收端数量分类

网络通信中，可以根据目标地址的个数及后续行为对通信进行分类，如单播、多播、广播等。

##### 网络的构成要素

搭建一套网络环境要设计各种各样的电缆和网络设备，主要有：

* 网卡（NIC）

使计算机联网的设备

* 中继器			
 
 从物理层延长网络的设备。由电缆传过来的电信号或者光信号经过中继器波形调整和放大再传给另一个电缆。

集线器也可以看做多端口的中继器。

* 网桥/2层交换机	

从数据链路层延长网络的设备

* 路由器/3层交换机	

通过网络层转发分组数据的设备

* 4-7层交换机		

处理传输层以上各层网络传输的设备

* 网关				

负责将从传输层到应用层的数据进行转换和转发的设备。

#### 第二章 TCP/IP基础知识

在计算机网络领域中，TCP/IP协议可谓名气最大、使用范围最广。

##### TCP/IP出现的背景及其历史

ARPANET利用几所大学与研究机构组成的主干网络进行分组交换和在互联计算机之间提供可靠传输的综合性通信协议的实验。到20世纪70年代前半叶，ARPANET中的一个研究机构研发了TCP/IP。在这之后，知道1982年，TCP/IP的具体规范内容才被最终定下来，并与次年成为ARPANET网络唯一指定的协议。

##### TCP/IP的标准化

* TCP/IP的具体含义

TCP/IP协议是利用IP进行通信时所必须用到的协议群的统称，该协议又被成为网际协议族。

* TCP/IP标准化精髓

TCP/IP协议的标准化过程具有两大特点：开放性和实用性。

开放性是由于TCP/IP的协议是由IETF讨论制定的，而IETF本身就是一个允许任何人加入讨论的组织。

在TCP/IP的标准化过程中，制定某一协议的规范本身已经不再那么重要，而首要任务是实现真正能够实现通信的技术。有人打趣道“TCP/IP简直是先开发程序，后写规格标准”。

* TCP/IP规范--RFC

TCP/IP中需要标准化的协议，被人们列入RFC(Request For Comment)文档并在网上公布、

##### 互联网基础知识

* 互联网定义

互联网是一个专有名词，对应的英文单词`The Internet`，指的是由ARPANET发展而来、互联全世界的计算机网络。

* 互联网与TCP/IP的关系

互联网进行通信时，需要相应的网络协议，TCP/IP原本就是为使用互联网而开发制定的协议族。因此，二者的关系是：互联网使用的协议是TCP/IP。

##### TCP/IP协议分层模型

* TCP/IP与OSI参考模型

二者关系如图所示：

![TCP/IP-OSI](https://github.com/wangzz/Blog/blob/master/image/%E3%80%8A%E5%9B%BE%E8%A7%A3TCP:IP%EF%BC%88%E7%AC%AC5%E7%89%88%EF%BC%89%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/7-10.jpg)

不难看出，OSI参考模型注重通信协议必要的功能是什么，而TCP/IP则强调在计算机上实现协议应该开发那种程序，即更看重实用性。

* 硬件

TCP/IP最底层负责数据传输的硬件，这种硬件相当于以太网或电话线等物理层的设备。

* 网络接口层

利用以太网中的数据链路层进行通信。

* 互联网层

使用IP协议，相当于OSI模型中的第三层网络层。TCP/IP分层中的`互联网层与传输层的功能通常由操作系统`提供。尤其是路由器，它必须实现通过互联网层转发分组数据包的功能。

此外，连接互联网的所有主机和路由器都必须实现IP的功能。其他连接互联网的网络设备（如网桥、中继器或集线器）就没必要一定实现IP或TCP的功能。

* 传输层

TCP/IP的传输层有两个具有代表性的协议：TCP/UDP，该层的功能与OSI参考模型中的传输层类似。

* 应用层

TCP/IP的分层中，将OSI参考模型中的会话层、表示层和应用层的功能都集中到了应用程序中实现。

##### TCP/IP分层模型与通信示例

* 数据包首部

每个分层中，都会对所发送的数据附加一个首部，这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息。

包、帧、数据报、段、消息的区别：

以上五个术语都用来表述数据的单位，包可以说是全能性述语；帧用于表示数据链路层中包的单位；数据报是IP/UDP等网络层以上分层中包的单位；段则表示TCP数据流中的信息；消息是应用协议中数据的单位。

#### 第三章 数据链路

##### 数据链路的作用

TCP/IP对OSI参考模型的数据链路层及物理层未做定义，然而数据链路的知识对深入理解TCP/IP与网络起着至关重要的作用。

数据链路层的协议定义了通过通信媒介互联的设备之间传输的规范。通信媒介包括双绞线电缆、同轴电缆、光纤、电波等介质。此外，各个设备之间也会通过交换机、网桥、中继器等中转数据。

在以太网与FDDI规范中，不仅包含了数据链路层，也规范了物理层的规格；而ATM规范中，也包含了网络层的一部分功能。

##### 数据链路相关技术

* MAC地址

MAC地址长48比特，其中：

第1位：单播地址(0)/多播地址(1)
第2位：全局地址(0)/本地地址(1)
第3~24位：由IEEE管理并保证各厂家之间不重复
第25~48位：由厂商管理并保证产品之间不重复

在使用网卡的情况下，MAC地址一般会被烧入ROM中。

##### 共享介质型网络

从通信介质的使用方法上看，网络可分为共享介质型和非共享介质型。

共享介质型网络指由多个设备共享一个通信介质的一种网络。在这种方式下，设备之间通过同一个载波信道进行发送和接收。为此，基本采用半双工通信，并需要对介质进行访问控制。

共享介质型网络中有两种介质访问控制方式：

* 争用方式

是指争夺获取数据传输的权利，也叫CSMA(载波监听多路访问)。这种方法采用先到先得的方式占用信道发送数据，多个站点同时发送帧就会产生冲突。

后来出现CSMA/CD(载波监听多路访问/冲突检测)，该方式提前检查冲突，一旦冲突，尽早释放信道，随机延迟一段时间后再试。

* 令牌传递方式

这种方式沿着令牌环发送一种叫做“令牌”的特殊报文，只有获得令牌的站才能发送数据。这就保证了每个站都有平等循环获得令牌的机会，而且即使网络拥堵也不会导致性能下降。

不过由于一个站在没有收到令牌前不能发送数据帧，网络不堵的时候数据链路的利用率也打不到100%。

##### 非共享介质网络

顾名思义，该种传输方式的传输介质是专用的。在这种方式下，网络中的每个站直连交换机，由交换机负责转发数据帧，很多情况下发送端和接收端采用全双工通信方式。

不过这种方式有一个致命弱点，一旦交换机发生故障，与之相连的所有计算机之间都无法通信。

##### 根据MAC地址转发

以太网交换机就是持有多个端口的网桥，它们根据数据链路层中每个帧的目标MAC地址，决定从哪个网络接口发送数据。这是所参考的、泳衣记录发送接口的表就叫做转发表。

* 交换机转发方式

存储转发方式检查以太网数据帧末尾的FCS位后再进行转发，因此可以避免发送由于冲突而被破坏的帧或噪音导致的错误帧。

直通转发方式不需要讲整个帧全部接收下来以后再进行转发，只需要得知目标地址即可转发。有点是延迟短，缺点是有可能转发错误帧。

##### 环路检测技术

当网桥连接网络时，一旦出现环路，有两种解决方式：生成树方式和源路由法。


##### 以太网

在众多数据链路中，最为著名、使用最为广泛的莫过于以太网（Ethernet）了。它规范简单，易于网卡及驱动程序实现。

以太网因通信电缆的不同以及通信速度的差异，衍生出了众多不同的以太网类型。

##### 其它数据链路

* PPP

* 无线通信

* ATM

ATM是一种面向连接的数据链路，因此在进行通信传输之前一定要设置通信线路。这一点与传统电话很相似。使用传统电话进行通话时，需要事先向交换机发出一个信令要求，建立交换机与通话对端的连接。而ATM允许同时与多个对端建立通信连接。

* POS

POS(Packet over SDH/SONET)是一种在SDH/SONET上进行包通信的协议。

SDH/SONET是在光纤上传输数字信号的物理层规范。

* FDDI

FDDI(Fiber Distributed Data Interface)叫做分布式光线数据接口。

#### 第四章 IP协议

IP（Internet Protocol,网际协议）主要负责将数据包发送给最终的目标计算机。因此IP能够让世界上任何两台计算机之间进行通信。

##### IP网际协议

TCP/IP的心脏是互联网层。这一层主要由IP和ICMP(Internet Control Message Protocol)两个协议组成。

* IP层作用

从前面章节可知，网络层的下一层--数据链路层主要作用是在互联同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。

网络层的作用就是跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传输。


##### IP基础知识

* IP地址属于网络层地址

MAC地址适用于识别同一数据链路中不同计算机的识别码，作为网络层的IP地址，用于在连接到网络中的所有主机中识别出进行通信的目标地址。

* 路由控制

路由控制是指将分组数据发送到最终目标地址的功能。

一跳的范围：

一跳（1 Hop）是指利用数据链路层以下分层的功能传输数据帧的一个区间。

以太网等数据链路中使用MAC地址传输数据帧，此时的一跳是指源MAC地址到目标MAC地址之间传输帧的区间。也就是说他是主机或路由器网卡不经过其它路由器而能直接到达相邻主机或路由器网卡之间的一个区间。在一跳的区间内，电缆可以通过网桥或交换集线器相连，不会通过路由器或网关相连。

路由器在或主机在转发IP数据包时只指定下一个路由器或主机而不是将最终目标地址为止的所有通路全都指定出来。因为每一跳在转发IP数据包时会分别指定下一跳的操作，直至包到达最终的目标地址。这一点和数据链路层数据帧在同一数据链路之间的转发思想很相似。

* 数据链路的抽象化

IP是实现多个数据链路之间通信的协议。数据链路根据种类的不同各有特点。对这些不同数据链路的相异特性进行抽象化也是IP的重要作用之一。因此，对IP的上一层来说，不论底层数据链路使用的是以太网还是无线LAN或者PPP，都将被一视同仁。


* IP属于面向无连接型

IP是面向无连接的点对点传输协议，在发包之前无需建立与对端目标地址之间的连接。上层如果有需要发送给IP的数据，该数据会立即被压缩成IP数据包发送出去。

IP采用面向无连接的原因：一是为了简化，而是为了提速。需要有连接时，可以委托上一层（TCP）提供此项服务。


##### IP地址基础知识

* IP地址的定义

IP地址（IPv4地址）由32位二进制数表示。TCP/IP通信要求将这样的IP地址分配给每一个参与通信的主机。

* IP地址由网络和主机两部分标识组成

网络标识在数据链路的每个段配置不同的值，网络标识必须保证相互连接的每个段地址不相重复。而相同段内互联的主机必须具有相同的网络地址。

IP的主机标识则不允许在同一个网段内重复出现。

由此，可以通过设置网络地址和主机地址，在相互连接的整个网络中保证每台主机的IP地址都不会相互重叠，即IP地址具有了唯一性。

* IP地址的分类

A类地址：

首位以0开头，从1~18位为网络标识，用十进制表示：0.0.0.0~127.0.0.0；

B类地址：

前两位为10，从1~16位为网络标识，用十进制表示：128.0.0.0~191.255.0.0；

C类地址：

以110开头，从1~24位为网络标识，用十进制表示：192.168.0.0~293.255.255.0；

D类地址：

以1110开头，从1~32位为网络标识，用十进制表示：244.0.0.0~239.255.255.255；

* 子网掩码

一个IP地址只要确定了其分类，就确定了它的网络标识和主机标识。网络标识相同的计算机必须属于同一链路，例如B类IP网络理论上允许六万五千多台计算机的情况，但这种网络结构是不存在的。因此，直接使用A类或B类地址，十分浪费。于是就出现了子网掩码。

有了子网掩码，一个IP地址的网络标识和主机标识就不再受限于该地址的类别，，而是由子网掩码通过子网网络地址细分出比A、B、C粒度更小的网络。

172.20.0.0的前16位是网络号，可以表示为：

172.20.0.0/16或者172.20/16

* 全局地址与私有地址

起初，互联网中的任何一台主机或路由器必须配备一个唯一的IP地址，一旦出现地址冲突，就会使发送端无法判断究竟应该发给哪个地址。而接收端收到数据包以后发送回执时，发送端也不知道究竟事哪个主机返回的信息。

然而，随着互联网的迅速普及，IP地址不足的问题日趋显著。如果一直按照现行的方法采用唯一地址，会有IP耗尽的危险。于是就出现了一种新技术，它不要求为每一台主机或路由器分配一个固定的IP地址，而是在必要的时候只为相应数量的设备分配唯一的IP地址。

对于没有连接互联网的独立网络中的主机，只要保证这个网络内地址唯一，就可以不用考虑互联网即可配置相应的IP地址。但这样也可能有问题（不小心误连到网络或者连接了两个本来独立的网络时），于是又出现了私有网络的IP地址，它的地址范围如下：


 地址范围  |         掩码表示            |        地址类别          
------------ | ------------------ | -------------
10.0.0.0 ~ 10.255.255.255 | 10/8 |	A类
172.16.0.0 ~ 172.31.255.255 | 172.16/12 | B类
192.168.0.0 ~ 192.168.255.255 | 192.168/16 | C类

包含在这个范围内的IP地址都属于私有IP，除此之外的都成为全局IP。

私有地址最早没计划连接互联网，而只用于互联网之外的独立网络。然而现在有了能够互换私有IP与全局IP的NAT技术后，配有私有地址的主机与配有全局地址的互联网主机就能实现通信。

全局IP地址基本上要在整个互联网范围内保持唯一，但私有IP地址不需要，只要在同一个域内保证唯一即可。


* 全局IP地址管理

全局IP地址由ICANN（Internet Corporation for Asigned Names and Numbers）管理。

在互联网被广泛商用之前，用户只有直接向管理机构申请共有IP地址才能接入互联网。然而，随着ISP的出现，人们在向ISP申请接入互联网的同时，还会申请全局IP地址。在这种情况下，实际上是ISP代替用户向管理机构申请了共有IP地址。

##### 路由控制

发送IP数据包时，仅知道对端IP地址还不足以实现将数据包发送到目标主机上，因为数据包发送方和接收方可能中间隔了很多个网络，我们还必须知道怎么通过这些网络到达目标主机。这就需要路由控制表的帮忙了。

路由控制表有两种：一种是静态路由，管理员手动设置；另一种动态路由，为路由器与其它路由器相互交换信息时自动刷新。

* IP地址与路由控制

IP地址的`网络地址`部分用于进行路由控制,路由控制表中记录着网络地址与`下一步应该发送至的路由器的地址`。

发送IP数据包时，首先要确定IP包首部中的目标地址。再从路由控制表中找到与该地址所在网络地址最吻合的记录，根据该记录将IP包转发给相应的下一个路由器。例如172.20.100.52的网络地址和172.20/16和172.20.100/24都吻合，但应该选择后者，它的匹配记录最长。

如果一张路由表中包含所有的网络及其子网的信息，将造成浪费，这时，默认路由是不错的选择。默认路由是指路由表中任何一个地址都能与之匹配的记录。默认路由只能存在于`末梢网络`中，一般标记为0.0.0.0/0或default。

* 路由表控制的聚合

通过路由信息的聚合，可以有效减少路由表的条目。

##### IP分割处理与再构成处理

* 数据链路不同，MTU不同

每种数据链路的MTU（最大传输单元）都不尽相同，而IP属于数据链路上一层，它必须不受限制于不同数据链路的MTU大小。

* IP报文的分片与重组

任何一台主机都有必要对IP分片进行相应的处理，分片往往在网络上遇到较大的报文无法一下子发送出去时才会处理。

经过分片之后的IP数据报在被重组的时候，只能在目标主机进行，路由器虽然做分片，但不会进行重组。这样处理的原因是多方面的，比如，现实中无法保证IP数据报是否通过同一个路径传送。

* 路径MTU发现

##### IPv6

IPv6是为了根本解决IPv4地址耗尽问题而被标准化的网际协议。

#### 第五章 IP协议相关技术

##### 仅凭IP无法完成通信

IP旨在让最终目标主机收到数据包，但仅有IP是无法完成通信的，必须还有能够解析主机名称和MAC地址的功能，以及数据包在发送过程中异常情况处理的功能等。

##### DNS

我们平时访问某个网站时，不使用IP地址，而是网址。而一般用户在使用TCP/IP进行通信时也不使用IP地址，这都要归功与DNS(Domain Name System)。

* IP地址不便于记忆

TCP/IP网络中要求每一个互联的计算机都要具有唯一的IP地址，并基于这个IP地址进行通信。然后直接使用IP地址有很多不便之处，不容易记忆。为此，TCP/IP世界从一开始就有了一种叫主机识别码的东西，这种识别方式是指为每台计算机赋以唯一的主机名，并能在网络通信时使用。为了实现这个功能，主机往往会利用一个叫做hosts的数据库文件，如果新增一台计算机或者某个计算机要变更IP地址，中心的hosts文件就得更新，而其它计算机则要定期下载最新的hosts文件才能正常使用网络。然而随着网络规模的不断扩大，这种集中管理主机名的方式可行性逐渐降低。

* DNS的产生

上述的背景之下，就产生了DNS系统，在这个系统中主机的管理机构可以对数据进行变更和设定。

* hosts文件

访问网站的时候，要先通过DNS服务器将要访问的域名解析成对应的IP地址。要是对于每个域名请求都要等待域名服务器解析后返回IP地址，访问网络的效率就会降低，因此可以通过利用hosts文件中建立域名和IP的映射关系来达到目的。只要hosts文件中有的域名记录，就不会再发起DNSi请求。

##### ARP

* ARP摘要

ARP(Address Resolution Protocol)是一个解决地址问题的协议。以目标IP地址为线索，用来定位下一个应该接收数据包的网络设备对应的MAC地址。如果目标主机不再同一个链路上，可以通过ARP查找下一跳路由器的MAC地址。

ARP只适用IPv4，不适用IPv6。

* ARP的工作机制

ARP是借助ARP请求与ARP响应两种类型的包确定MAC地址的。

主机A想要获得主机B的MAC地址，起初要通过广播发送一个ARP请求包，这个包中包含了想要了解其MAC地址的主机IP地址；

广播的包会被同一链路上的所有主机和路由器接收并解析，如果请求包中的目标IP地址与自己的IP地址一致，那么这个节点就将自己的MAC地址塞入ARP响应包返回给主机A；

由此，可以通过ARP获得MAC地址，并实现链路内的IP通信。

根据ARP可以动态地进行地址解析，因此TCP/IP的网络构造和网络通信中无需事先知道MAC地址究竟是什么，只要有IP地址即可。

如果每发送一个IP数据报都要进行一次ARP请求以确定MAC地址，将会造成不必要的网络流量，通常的做法是将获得的MAC地址放到ARP缓存表中存放一段时间，下次再发起ARP之前先查表，表中没有再真正发起。


* RARP

RARP（Reverse Address Resolution Protocol）是将ARP反过来，从MAC地址定位IP地址的一种协议。该协议用于没有任何输入接口或无法通过DHCP动态获取IP地址的设备，根据MAC地址获得IP地址的情况。

* 代理ARP

通常ARP包会被路由器隔离，但是采用代理ARP的路由器可以将ARP请求转发给临近的网段，这样两个以上网段的节点之间就可以像在同一网段中一样通信了。

##### ICPM

* 辅助IP的ICMP

ICMP的功能包括：确认IP包是否成功发送到目标地址，通知在发送过程中网络是否正常、设置是否有误，以及设备是否有异常等。

有了这些功能以后，就可以获得网络是否正常、设置是否有误，从而方便进行网络上的问题诊断。

ICMP在IPv6中的版本为ICMPv6。

##### NAT

* NAT定义

NAT（Network Address Translator）是用于在本网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术。

NAT实际上是为了延缓IPv4中地址枯竭的问题。

* NAT的工作机制

在NAT路由器内部，有一张自动生成的用来转换地址的表。当私有地址A向私有地址B发送第一个包时生成这张表，并按表中的映射关系进行处理。

#### 第六章 TCP与UDP

TCP/IP中有两个具有代表性的传输层协议：TCP/UDP。TCP提供可靠的通信传输，UDP则常被用于让广播和细节控制交给应用的通信传输。根据通信的具体特征，选择合适的传输协议非常重要。

##### 传输层定义

传输层需要指出具体的端口号，通过端口号识别在传输层上一层的应用层中所要进行处理的具体程序。

##### TCP和UDP

* TCP

TCP提供面向连接的、可靠的流协议，实行顺序控制或重发控制机制，此外还具备流量控制、拥塞控制、提高网络利用率等众多功能。

* UDP

UDP不提供可靠型的数据传输。细微的处理会交给上层的应用去完成，应用有时会根据自己的需要进行重发处理。

##### TCP

TCP与UDP的区别相当大，它充分实现了数据传输时各种控制功能，可以进行丢包时的重发控制，还可以对次序乱掉的数据包进行顺序控制。此外，TCP作为一种面向连接的协议，只有在确认通信对端存在时才会发送数据，从而可以控制通信流量的浪费。

根据TCP的这些机制，在IP这种无连接的网络上也能实现高可靠性的通信。

* TCP的特点及其目的

为了通过IP数据报实现可靠传输，需要解决数据的丢包、重复以及分片顺序混乱等问题。TCP通过检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠传输。

* 通过序列号与确认应答提高可靠性

发送端的数据到达接收主机时，接收端主机会返回一个已收到消息的通知，这个消息叫做`确认应答（ACK）`。当发送端将数据发出之后会等待对端的确认应答，如果有确认应答，说明数据已经成功到达对端；如果一段时间内没有等到确认应答，发送端就可以认为数据已经丢失，并进行重发。

确认应答处理、重发控制以及重复控制等功能都可以通过序列号实现。序列号是顺序给发送数据的每一个字节都标上号码的编号。接收端查询接收数据TCP首部中的序列号和数据的长度，将自己下一步应该接收的序号作为确认应答返送回去。就这样，通过序列号和确认应答号，TCP可以实现可靠传输。

* 重发超时如何控制

重发超时是指在重发数据之前，等待确认应答到来的那个特定时间间隔。如果超过这个时间仍未收到确认应答，发送端将进行数据重发。

最理想的是找到一个最小时间，它能保证"确认应答能在这个时间内返回"。然而这个时间随着数据包途径的网络环境不同会有变化。为此，TCP在每次发包时都会计算往返时间及其偏差，将这个往返时间和偏差相加，重发超时的时间就是比这个总和稍大一点的值。

数据被重发之后若还是收不到确认应答，则进行再次发送。此时，等待确认应答的时间将会以2倍、4倍的指数函数延长。当然，数据也不会被无限次反复的重发，达到一定重发次数后，如果仍没有任何确认应答返回，就会判断为网络或对端主机发生了异常，强制关闭连接，并且通知应用通信异常强行终止。

* 连接管理

TCP在数据通信之前，先通过首部发送一个SYN包作为建立连接的请求等待确认应答。如果对端发来确认应答，则认为可以进行数据通信。如果对端的确认应答未能到达，就不会进行数据通信。此外，在通信结束时还会进行断开连接的处理（FIN包）。

即TCP是通过首部用于控制的字段来管理TCP连接。

* TCP以段为单位发送数据

在建立TCP连接的同时，也可以确定发送数据包的单位，我们称之为`最大消息长度（MSS：Maximum Segment Size）`。最理想的情况是，最大消息长度正好是IP中不会被分片处理的最大数据长度。

TCP在传送大量数据时，是以MSS的大小将数据进行分割发送。进行重发时也是以MSS为单位。

MSS是在三次握手的时候，在两端主机之间被计算得出。两端主机在发出建立连接的请求时，都会在TCP首部中写入MSS选项，告诉对方自己的接口能够适应MSS的大小，然后会在两者之间选择一个较小的值投入使用。

* 利用窗口控制提高速度

TCP以段为单位，每发送一个段进行一次确认应答的处理。这样的传输方式有一个缺点，包往返时间越长，通信性能就越低。

为了解决这个问题，TCP引入了窗口这个概念，即使在往返时间较长的情况下，它也能控制网络性能的下降。窗口机制中，确认应答不再是以每个分段，而是以更大的单位进行确认时，转发时间将会被大幅度的缩短。也就是说，发送端主机在发送了一个段以后不必要一直等待确认应答，而是继续发送。窗口大小就是指无需等待确认应答而可以继续发送数据的最大值。

* 窗口控制与重发控制

使用窗口控制时，如果出现段丢失该怎么办？

首先，对于确认应答未能返回的情况，数据已经到达对端，在使用窗口控制时，是不需要再进行重发的。

其次，对于某个报文段丢失的情况，接收主机如果收到一个自己应该接收的序号以外的数据时，就会针对当前为止收到数据，返回确认应答。而发送端主机如果连续3次收到同一个确认应答，就会将其所对应的数据进行重发。这种机制被称为告诉重发控制。

* 流控制

发送端根据自己的实际情况发送数据，但是接收端可能收到的是一个毫无关系的数据包，有可能会在处理其他问题上话费一些时间。因此在为这个数据包做其他处理时会耗费一些时间，甚至在高负荷的情况下无法接收任何数据。如此以来，如果接收端将本应该接收的数据丢弃的话，就又会出发重发机制，从而导致网络流量的无端良妃。

为了防止这种现象的发生，TCP提供一种机制可以让发送端根据接收端的实际接受能力控制发送端的数据量，这就是流量控制。它的具体实现是：接收端主机向发送端主机通知自己可以接收数据的大小，于是发送端会发送不超过这个限度的数据。改限度大小就被成为窗口大小。前面介绍的窗口大小的值就是有接收端主机决定的。接收端的缓存区一旦面临数据溢出时，窗口的大小值会随之被设置为一个更小的值通知给发送端，从而控制数据发送量。

* 拥塞控制

有了TCP的窗口控制，收发主机之间及时不再以一个数据段为单位发送确认应答，也能连续发送大量数据包。然而在通信刚开始时就发送大量数据，可能会引发其他问题。

TCP为了防止该问题的出现，在通信一开始时就会通过一个叫做慢启动的算法得出的数值对发送数据量进行控制。

首先，为了在发送端调节所要发送数据的量，定义一个叫做`拥塞窗口`的概念。在慢启动的时候，拥塞窗口大小设置为1个数据段。之后每收到一个ACK，拥塞窗口的值就加1。在发送数据包时，将拥塞窗口的大小与接收端主机通知的窗口大小作比较，然后选择其中较小的值。

#### 第七章 路由协议

##### 路由控制的定义

* IP地址与路由控制

路由器根据路由控制表转发数据包时，根据所收到的数据包中目标主机的ＩＰ地址与路由控制表的比较得出下一个应该接收的路由器。

* 静态路由与动态路由

路由控制分静态和动态两种类型。

静态路由是指手动设置的主机或路由器中的路由信息；动态路由是指让协议在运行过程中自动地设置路由控制信息的方法。
 
* 动态路由的基础

路由器会给相邻路由器发送自己已知的网络连接信息，而这些信息又会像接力一样传递给其它路由器，直至整个网络都了解时，路由控制表也就制作完成了。

##### 路由控制范围

随着IP网络的发展，想要对所有网络统一管理是不可能的事，因此人们根据路由控制的范围常使用IGP(Interior Gateway Protocol)和EGP(Exterior Gateway Protocol)两种类型的路由协议。

* 接入互联网的各种组织结构

互联网连接着世界各地的组织机构，不仅包括语言不通的，甚至宗教信仰全然不同的组织。没有管理者，也没有被管理者，每个组织之间保持着平等的关系。

* 自治系统与路由协议

指定自己的路由策略，并以此为准在一个或多个网络群体中采用的小型单位叫自治系统（AS:Autonomous System）或路由选择域（Routing Domain）。

说道自制系统，区域网络、ISP（互联网服务提供商）等都是典型的例子。

* IGP与EGP

如前所述，路由协议分为两大类，一类是外部网关协议EGP，另一类是内部网关协议IGP。

IP地址分为网络部分和主机部分，它们有各自的分工。EGP和IGP的关系与IP地址网络部分和主机部分的关系有相似之处。就像根据IP地址中的网络部分在网络之间进行路由选择，根据主机本分在链路内部进行主机识别一样，可以根据EGP在区域网络（或ISP之间）进行路由选择，也可以根据IGP在区域网络内部（或ISP内部）进行主机识别。

由此，路由协议被分为EGP和IGP两个层次。没有EGP就不可能有世界上各个不同组织机构之间的通信。没有IGP机构内部也就不可能进行通信。

IGP中可以使用RIP（Routing Information Protocol，路由信息协议）、RIP2、OSPF（Open Shortest Path First，开放式最短路径优先）等协议；

EGP使用的是BGP（Border Gateway Protocol，边界网关协议）协议。


##### 路由算法

路由控制有各种各样的算法，其中最有代表性的有两种，距离向量（Distance-Vector）算法和链路状态（Link-State）算法。

* 距离向量算法

距离向量算法根据距离（代价）和方向决定目标网络或目标主机位置。

路由器之间可以互换目标网络的方向及其距离的相关信息，并以这些信息为基础制作路由控制表。这种方法处理简单，但当网络构造分外复杂时，在获得稳定的路由信息之前还要消耗一定时间，也极易发生路由循环等问题。

* 链路状态算法

链路状态算法是由路由器在了解网络整体连接状态的基础上生成路由控制表的一种方法。该方法中，每个路由器必须保持同样的信息才能进行正确的路由选择。

为实现上述机制，链路状态算法付出的代价就是如何从网络代理获取路由信息表。这一过程相当复杂，特别是一个巨大而又复杂的网络结构中，管理和处理信息需要告诉CPU处理能力和大量的内存。


##### RIP

RIP（Routing Information Protocol）是距离向量型的一种路由协议，广泛用于LAN。

* 广播路由控制信息

RIP将路由控制信息定期（30秒一次）向全网广播。如果没有收到路由控制信息，连接就会被断开。不过这有可能是丢包导致的，因此，RIP规定等待5次。如果等了6此后仍未收到路由信息，才会真的关闭连接。

* 根据距离向量确定路由

RIP基于距离向量算法决定路径。距离（Metrics）的单位为`跳数`。跳数是指所经过的路由器的个数。RIP希望尽可能少通过路由器将数据包转发到目标IP地址。根据距离向量生成距离向量表，再抽出较小的路由生成最终的路由控制表。


##### OSPF

OSPF（Open Shortest Path First）是根据OSI的IS-IS协议提出的一种链路状态型路由协议。另外，OSPF支持子网掩码，曾经在RIP中无法实现的可变长度子网构造的网络路由控制成为现实。

* OSPF是链路状态型路由协议

OSPF根据路由器之间交换链路状态生成网络拓扑信息，然后再根据这个拓扑信息生成路由控制表。

RIP的路由选择，要求途中经过的路由器个数越少越好；与之相比，OSPF可以给每条链路赋予一个权重，最终选择一个权重最小的路径作为最终路由。

##### BGP

BGP（Border Gateway Protocol），边界网关协议是连接不同组织结构（或者说连接不同自治系统）的一种协议，主要用于ISP之间相连接的部分，它属于外部网关洗衣（EGP）。只有BGP、RIP和OSPF共同进行路由控制，才能进行整个互联网的路由控制。
